{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block title %}Product Analytics{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.analytics-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}
.analytics-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #417690;
    padding-bottom: 10px;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.data-table th, .data-table td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}
.data-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}
.data-table tr:hover {
    background-color: #f5f5f5;
}
.chart-container {
    position: relative;
    height: 300px;
    margin-top: 20px;
}
.nav-tabs {
    margin: 20px 0;
    border-bottom: 2px solid #417690;
}
.nav-tabs a {
    display: inline-block;
    padding: 10px 20px;
    text-decoration: none;
    color: #417690;
    border-bottom: 2px solid transparent;
    margin-right: 10px;
}
.nav-tabs a.active, .nav-tabs a:hover {
    color: #417690;
    border-bottom-color: #417690;
    background-color: #f8f9fa;
}
.conversion-rate {
    padding: 4px 8px;
    border-radius: 4px;
    color: white;
    font-size: 0.9em;
}
.rate-high { background-color: #70ad47; }
.rate-medium { background-color: #ffc000; }
.rate-low { background-color: #c55a11; }
.product-link {
    color: #417690;
    text-decoration: none;
}
.product-link:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<h1>üõçÔ∏è Product Analytics</h1>

<div class="nav-tabs">
    <a href="{% url 'admin:analytics_dashboard' %}">Overview</a>
    <a href="{% url 'admin:visitor_analytics' %}">Visitors</a>
    <a href="{% url 'admin:product_analytics' %}" class="active">Products</a>
    <a href="{% url 'admin:real_time_analytics' %}">Real-time</a>
</div>

<!-- Category Performance -->
<div class="analytics-card">
    <h3>üìä Category Performance</h3>
    <div class="chart-container">
        <canvas id="categoryChart"></canvas>
    </div>
    
    <table class="data-table" style="margin-top: 20px;">
        <thead>
            <tr>
                <th>Category</th>
                <th>Total Views</th>
                <th>Unique Views</th>
                <th>Cart Additions</th>
                <th>Conversion Rate</th>
            </tr>
        </thead>
        <tbody>
            {% for category in category_stats %}
            <tr>
                <td><strong>{{ category.name }}</strong></td>
                <td>{{ category.total_views|intcomma }}</td>
                <td>{{ category.unique_views|intcomma }}</td>
                <td>{{ category.cart_additions|intcomma }}</td>
                <td>
                    {% if category.unique_views > 0 %}
                        {% widthratio category.cart_additions category.unique_views 100 as conv_rate %}
                        <span class="conversion-rate {% if conv_rate >= 10 %}rate-high{% elif conv_rate >= 5 %}rate-medium{% else %}rate-low{% endif %}">
                            {{ conv_rate }}%
                        </span>
                    {% else %}
                        <span class="conversion-rate rate-low">0%</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5">No category data available</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Popular Products -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>üèÜ Top Products by Views</h3>
        <div class="chart-container">
            <canvas id="popularChart"></canvas>
        </div>
    </div>
    
    <div class="analytics-card">
        <h3>üí∞ Top Products by Conversions</h3>
        <div class="chart-container">
            <canvas id="conversionChart"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Product Table -->
<div class="analytics-card">
    <h3>üìã Detailed Product Statistics</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Category</th>
                <th>Total Views</th>
                <th>Unique Views</th>
                <th>Avg. Time (sec)</th>
                <th>Cart Additions</th>
                <th>Conversion Rate</th>
                <th>Last Viewed</th>
            </tr>
        </thead>
        <tbody>
            {% for pop_product in popular_products %}
            <tr>
                <td>
                    <a href="{% url 'admin:products_product_change' pop_product.product.id %}" 
                       class="product-link" target="_blank">
                        {{ pop_product.product.name|truncatechars:50 }}
                    </a>
                </td>
                <td>{{ pop_product.product.category.name }}</td>
                <td>{{ pop_product.total_views|intcomma }}</td>
                <td>{{ pop_product.unique_views|intcomma }}</td>
                <td>{{ pop_product.avg_time_viewed|floatformat:0 }}</td>
                <td>{{ pop_product.cart_additions|intcomma }}</td>
                <td>
                    <span class="conversion-rate {% if pop_product.conversion_rate >= 10 %}rate-high{% elif pop_product.conversion_rate >= 5 %}rate-medium{% else %}rate-low{% endif %}">
                        {{ pop_product.conversion_rate|floatformat:1 }}%
                    </span>
                </td>
                <td>
                    {% if pop_product.last_viewed %}
                        {{ pop_product.last_viewed|timesince }} ago
                    {% else %}
                        Never
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="8">No product data available</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Recent Product Activity -->
<div class="analytics-card">
    <h3>üïê Recent Product Views</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Visitor</th>
                <th>Product</th>
                <th>Time on Page</th>
                <th>Scroll Depth</th>
                <th>Added to Cart</th>
            </tr>
        </thead>
        <tbody>
            {% for pv in recent_product_views|slice:":20" %}
            <tr>
                <td>{{ pv.timestamp|timesince }} ago</td>
                <td>
                    <a href="{% url 'admin:analytics_visitor_change' pv.visitor.id %}" 
                       class="product-link">
                        {{ pv.visitor.ip_address }}
                    </a>
                    <br><small>{{ pv.visitor.country }}, {{ pv.visitor.city }}</small>
                </td>
                <td>
                    <a href="{% url 'admin:products_product_change' pv.product.id %}" 
                       class="product-link" target="_blank">
                        {{ pv.product.name|truncatechars:40 }}
                    </a>
                </td>
                <td>
                    {% if pv.time_on_page %}
                        {{ pv.time_on_page }} sec
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td>
                    {% if pv.scroll_depth %}
                        {{ pv.scroll_depth }}%
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td>
                    {% if pv.added_to_cart %}
                        <span style="color: #70ad47; font-weight: bold;">‚úì Yes</span>
                    {% else %}
                        <span style="color: #c55a11;">‚úó No</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6">No recent product views</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Category performance chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryStats = {{ category_stats|safe }};

new Chart(categoryCtx, {
    type: 'bar',
    data: {
        labels: categoryStats.map(c => c.name),
        datasets: [{
            label: 'Total Views',
            data: categoryStats.map(c => c.total_views),
            backgroundColor: '#417690',
            yAxisID: 'y'
        }, {
            label: 'Cart Additions',
            data: categoryStats.map(c => c.cart_additions),
            backgroundColor: '#70ad47',
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Views'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Cart Additions'
                },
                grid: {
                    drawOnChartArea: false,
                }
            },
            x: {
                ticks: {
                    maxRotation: 45
                }
            }
        }
    }
});

// Popular products chart
const popularCtx = document.getElementById('popularChart').getContext('2d');
const topProducts = {{ popular_products|slice:":8"|safe }};

new Chart(popularCtx, {
    type: 'horizontalBar',
    data: {
        labels: topProducts.map(p => p.product.name.length > 25 ? p.product.name.substring(0, 25) + '...' : p.product.name),
        datasets: [{
            label: 'Total Views',
            data: topProducts.map(p => p.total_views),
            backgroundColor: '#5b9bd5'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});

// Conversion chart
const conversionCtx = document.getElementById('conversionChart').getContext('2d');
const topConverters = topProducts.filter(p => p.cart_additions > 0).slice(0, 8);

new Chart(conversionCtx, {
    type: 'horizontalBar',
    data: {
        labels: topConverters.map(p => p.product.name.length > 25 ? p.product.name.substring(0, 25) + '...' : p.product.name),
        datasets: [{
            label: 'Cart Additions',
            data: topConverters.map(p => p.cart_additions),
            backgroundColor: '#70ad47'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true
            }
        }
    }
});
</script>

{% endblock %}