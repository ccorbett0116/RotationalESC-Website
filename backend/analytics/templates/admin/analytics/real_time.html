{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block title %}Real-time Analytics{% endblock %}

{% block extrahead %}
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.analytics-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}
.analytics-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #417690;
    padding-bottom: 10px;
}
.metric-card {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #c55a11, #ffc000);
    color: white;
    border-radius: 8px;
    margin: 10px;
}
.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 10px;
}
.metric-label {
    font-size: 1.1em;
    opacity: 0.9;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.data-table th, .data-table td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}
.data-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}
.data-table tr:hover {
    background-color: #f5f5f5;
}
.nav-tabs {
    margin: 20px 0;
    border-bottom: 2px solid #417690;
}
.nav-tabs a {
    display: inline-block;
    padding: 10px 20px;
    text-decoration: none;
    color: #417690;
    border-bottom: 2px solid transparent;
    margin-right: 10px;
}
.nav-tabs a.active, .nav-tabs a:hover {
    color: #417690;
    border-bottom-color: #417690;
    background-color: #f8f9fa;
}
.online-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #70ad47;
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
.event-type {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    color: white;
    font-weight: bold;
}
.event-click { background-color: #417690; }
.event-cart_add { background-color: #70ad47; }
.event-cart_remove { background-color: #c55a11; }
.event-download { background-color: #5b9bd5; }
.event-form_submit { background-color: #a64d79; }
.refresh-button {
    background-color: #417690;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 20px;
}
.refresh-button:hover {
    background-color: #335577;
}
.auto-refresh {
    float: right;
    margin-left: 10px;
}
</style>
{% endblock %}

{% block content %}
<h1>âš¡ Real-time Analytics</h1>

<div class="nav-tabs">
    <a href="{% url 'admin:analytics_dashboard' %}">Overview</a>
    <a href="{% url 'admin:visitor_analytics' %}">Visitors</a>
    <a href="{% url 'admin:product_analytics' %}">Products</a>
    <a href="{% url 'admin:real_time_analytics' %}" class="active">Real-time</a>
</div>

<button class="refresh-button" onclick="window.location.reload()">
    ðŸ”„ Refresh Data
</button>
<div class="auto-refresh">
    <label>
        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()"> 
        Auto-refresh (30s)
    </label>
</div>

<!-- Real-time Metrics -->
<div class="analytics-grid">
    <div class="metric-card">
        <div class="metric-value">
            <span class="online-indicator"></span>{{ real_time_stats.visitors_online|intcomma }}
        </div>
        <div class="metric-label">Visitors Online Now</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ real_time_stats.visitors_last_hour|intcomma }}</div>
        <div class="metric-label">Visitors Last Hour</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ real_time_stats.page_views_last_hour|intcomma }}</div>
        <div class="metric-label">Page Views Last Hour</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ real_time_stats.events_last_hour|intcomma }}</div>
        <div class="metric-label">Events Last Hour</div>
    </div>
</div>

<!-- Active Content -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>ðŸ”¥ Currently Popular Pages</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Page Path</th>
                    <th>Views (Last Hour)</th>
                </tr>
            </thead>
            <tbody>
                {% for page in current_popular %}
                <tr>
                    <td>{{ page.path }}</td>
                    <td>{{ page.views|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2">No current page views</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-card">
        <h3>ðŸ‘¥ Active Visitors (Last 5 Minutes)</h3>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>ISP</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visitor in active_visitors %}
                    <tr>
                        <td>
                            <span class="online-indicator"></span>
                            <a href="{% url 'admin:analytics_visitor_change' visitor.id %}" style="color: #417690;">
                                {{ visitor.ip_address }}
                            </a>
                        </td>
                        <td>{{ visitor.city }}, {{ visitor.country }}</td>
                        <td>{{ visitor.isp|truncatechars:30 }}</td>
                        <td>{{ visitor.last_visit|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4">No active visitors</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recent Events -->
<div class="analytics-card">
    <h3>ðŸ“Š Recent User Events (Last Hour)</h3>
    <div style="max-height: 500px; overflow-y: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Event</th>
                    <th>Visitor</th>
                    <th>Page</th>
                    <th>Details</th>
                    <th>Product</th>
                </tr>
            </thead>
            <tbody>
                {% for event in recent_events %}
                <tr>
                    <td style="white-space: nowrap;">{{ event.timestamp|date:"H:i:s" }}</td>
                    <td>
                        <span class="event-type event-{{ event.event_type }}">
                            {{ event.get_event_type_display }}
                        </span>
                    </td>
                    <td>
                        <a href="{% url 'admin:analytics_visitor_change' event.visitor.id %}" style="color: #417690;">
                            {{ event.visitor.ip_address }}
                        </a>
                        <br><small>{{ event.visitor.country }}</small>
                    </td>
                    <td>{{ event.page_path|truncatechars:30 }}</td>
                    <td>
                        {% if event.element_text %}
                            {{ event.element_text|truncatechars:40 }}
                        {% elif event.element_id %}
                            #{{ event.element_id }}
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                    <td>
                        {% if event.product %}
                            <a href="{% url 'admin:products_product_change' event.product.id %}" 
                               style="color: #417690;" target="_blank">
                                {{ event.product.name|truncatechars:30 }}
                            </a>
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6">No recent events</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Top Pages Right Now -->
<div class="analytics-card">
    <h3>ðŸ“ˆ Most Active Pages (Last Hour)</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Page</th>
                <th>Views</th>
                <th>Unique Visitors</th>
            </tr>
        </thead>
        <tbody>
            {% for page in real_time_stats.top_pages_last_hour %}
            <tr>
                <td>{{ page.path }}</td>
                <td>{{ page.views|intcomma }}</td>
                <td>{{ page.unique_visitors|intcomma|default:"â€”" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3">No page data available</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
let autoRefreshInterval = null;

function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(() => {
            window.location.reload();
        }, 30000);
        console.log('Auto-refresh enabled (30 seconds)');
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        console.log('Auto-refresh disabled');
    }
}

// Show last refresh time
document.addEventListener('DOMContentLoaded', function() {
    const refreshTime = new Date().toLocaleTimeString();
    document.querySelector('h1').innerHTML += ` <small style="color: #666; font-size: 0.6em;">Last updated: ${refreshTime}</small>`;
});
</script>

{% endblock %}