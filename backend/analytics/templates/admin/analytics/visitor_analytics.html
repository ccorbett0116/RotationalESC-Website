{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block title %}Visitor Analytics{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.analytics-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}
.analytics-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #417690;
    padding-bottom: 10px;
}
.metric-card {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #70ad47, #a9d18e);
    color: white;
    border-radius: 8px;
    margin: 10px;
}
.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 10px;
}
.metric-label {
    font-size: 1.1em;
    opacity: 0.9;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.data-table th, .data-table td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}
.data-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}
.data-table tr:hover {
    background-color: #f5f5f5;
}
.chart-container {
    position: relative;
    height: 300px;
    margin-top: 20px;
}
.nav-tabs {
    margin: 20px 0;
    border-bottom: 2px solid #417690;
}
.nav-tabs a {
    display: inline-block;
    padding: 10px 20px;
    text-decoration: none;
    color: #417690;
    border-bottom: 2px solid transparent;
    margin-right: 10px;
}
.nav-tabs a.active, .nav-tabs a:hover {
    color: #417690;
    border-bottom-color: #417690;
    background-color: #f8f9fa;
}
.timeframe-selector {
    margin: 20px 0;
    text-align: right;
}
.timeframe-selector select {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #ddd;
}
</style>
{% endblock %}

{% block content %}
<h1>üë• Visitor Analytics</h1>

<div class="nav-tabs">
    <a href="{% url 'admin:analytics_dashboard' %}">Overview</a>
    <a href="{% url 'admin:visitor_analytics' %}" class="active">Visitors</a>
    <a href="{% url 'admin:product_analytics' %}">Products</a>
    <a href="{% url 'admin:real_time_analytics' %}">Real-time</a>
</div>

<div class="timeframe-selector">
    <label for="timeframe">Time Period:</label>
    <select id="timeframe" onchange="changeTimeframe(this.value)">
        <option value="day" {% if timeframe == 'day' %}selected{% endif %}>Last 24 Hours</option>
        <option value="week" {% if timeframe == 'week' %}selected{% endif %}>Last 7 Days</option>
        <option value="month" {% if timeframe == 'month' %}selected{% endif %}>Last 30 Days</option>
    </select>
</div>

<!-- Key Metrics -->
<div class="analytics-grid">
    <div class="metric-card">
        <div class="metric-value">{{ total_sessions|intcomma }}</div>
        <div class="metric-label">Total Sessions</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ bounce_rate }}%</div>
        <div class="metric-label">Bounce Rate</div>
    </div>
</div>

<!-- Geographic Data -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>üåç Geographic Distribution</h3>
        <div class="chart-container">
            <canvas id="geoChart"></canvas>
        </div>
    </div>
    
    <div class="analytics-card">
        <h3>üè¢ Top Internet Providers</h3>
        <div class="chart-container">
            <canvas id="ispChart"></canvas>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>üìç Detailed Location Data</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Country</th>
                    <th>Region</th>
                    <th>City</th>
                    <th>Visitors</th>
                </tr>
            </thead>
            <tbody>
                {% for location in country_data|slice:":20" %}
                <tr>
                    <td>{{ location.country }}</td>
                    <td>{{ location.region|default:"‚Äî" }}</td>
                    <td>{{ location.city|default:"‚Äî" }}</td>
                    <td>{{ location.count|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">No location data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-card">
        <h3>üåê ISP Details</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Internet Service Provider</th>
                    <th>Visitors</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for isp_item in isp_data %}
                <tr>
                    <td>{{ isp_item.isp|truncatechars:50 }}</td>
                    <td>{{ isp_item.count|intcomma }}</td>
                    <td>{% widthratio isp_item.count total_sessions 100 %}%</td>
                </tr>
                {% empty %}
                <tr><td colspan="3">No ISP data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Browser Information -->
<div class="analytics-card">
    <h3>üíª Browser & Device Information</h3>
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>User Agent</th>
                </tr>
            </thead>
            <tbody>
                {% for ua in user_agents|slice:":50" %}
                <tr>
                    <td style="font-family: monospace; font-size: 0.9em;">{{ ua|truncatechars:100 }}</td>
                </tr>
                {% empty %}
                <tr><td>No user agent data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Geographic chart
const geoCtx = document.getElementById('geoChart').getContext('2d');
const countryData = {{ country_data|safe }};
const topCountries = countryData.slice(0, 10);

new Chart(geoCtx, {
    type: 'bar',
    data: {
        labels: topCountries.map(c => c.country),
        datasets: [{
            label: 'Visitors',
            data: topCountries.map(c => c.count),
            backgroundColor: '#70ad47',
            borderColor: '#507e2f',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            },
            x: {
                ticks: {
                    maxRotation: 45
                }
            }
        }
    }
});

// ISP chart
const ispCtx = document.getElementById('ispChart').getContext('2d');
const ispData = {{ isp_data|safe }};
const topIsps = ispData.slice(0, 8);

new Chart(ispCtx, {
    type: 'doughnut',
    data: {
        labels: topIsps.map(i => i.isp.length > 20 ? i.isp.substring(0, 20) + '...' : i.isp),
        datasets: [{
            data: topIsps.map(i => i.count),
            backgroundColor: [
                '#70ad47', '#a9d18e', '#ffc000', '#c55a11',
                '#417690', '#5b9bd5', '#a64d79', '#636363'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    boxWidth: 12
                }
            }
        }
    }
});

function changeTimeframe(timeframe) {
    window.location.href = '?timeframe=' + timeframe;
}
</script>

{% endblock %}