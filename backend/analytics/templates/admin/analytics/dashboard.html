{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.analytics-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
}
.analytics-card h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #417690;
    padding-bottom: 10px;
}
.metric-card {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #417690, #5b9bd5);
    color: white;
    border-radius: 8px;
    margin: 10px;
}
.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 10px;
}
.metric-label {
    font-size: 1.1em;
    opacity: 0.9;
}
.timeframe-selector {
    margin: 20px 0;
    text-align: right;
}
.timeframe-selector select {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #ddd;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.data-table th, .data-table td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}
.data-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}
.data-table tr:hover {
    background-color: #f5f5f5;
}
.chart-container {
    position: relative;
    height: 300px;
    margin-top: 20px;
}
.nav-tabs {
    margin: 20px 0;
    border-bottom: 2px solid #417690;
}
.nav-tabs a {
    display: inline-block;
    padding: 10px 20px;
    text-decoration: none;
    color: #417690;
    border-bottom: 2px solid transparent;
    margin-right: 10px;
}
.nav-tabs a.active, .nav-tabs a:hover {
    color: #417690;
    border-bottom-color: #417690;
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<h1>üìä Website Analytics Dashboard</h1>

<div class="nav-tabs">
    <a href="{% url 'admin:analytics_dashboard' %}" class="active">Overview</a>
    <a href="{% url 'admin:visitor_analytics' %}">Visitors</a>
    <a href="{% url 'admin:product_analytics' %}">Products</a>
    <a href="{% url 'admin:real_time_analytics' %}">Real-time</a>
</div>

<div class="timeframe-selector">
    <label for="timeframe">Time Period:</label>
    <select id="timeframe" onchange="changeTimeframe(this.value)">
        <option value="day" {% if timeframe == 'day' %}selected{% endif %}>Last 24 Hours</option>
        <option value="week" {% if timeframe == 'week' %}selected{% endif %}>Last 7 Days</option>
        <option value="month" {% if timeframe == 'month' %}selected{% endif %}>Last 30 Days</option>
    </select>
</div>

<!-- Key Metrics -->
<div class="analytics-grid">
    <div class="metric-card">
        <div class="metric-value">{{ total_visitors|intcomma }}</div>
        <div class="metric-label">Total Visitors</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ visitors_period|intcomma }}</div>
        <div class="metric-label">Visitors ({{ timeframe|title }})</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ page_views_period|intcomma }}</div>
        <div class="metric-label">Page Views</div>
    </div>
    <div class="metric-card">
        <div class="metric-value">{{ product_views_period|intcomma }}</div>
        <div class="metric-label">Product Views</div>
    </div>
</div>

<!-- Charts -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>üìà Daily Traffic Trend</h3>
        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
    <div class="analytics-card">
        <h3>üåç Top Countries</h3>
        <div class="chart-container">
            <canvas id="countriesChart"></canvas>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="analytics-grid">
    <div class="analytics-card">
        <h3>üìÑ Most Popular Pages</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Page Path</th>
                    <th>Views</th>
                </tr>
            </thead>
            <tbody>
                {% for page in top_pages %}
                <tr>
                    <td>{{ page.path }}</td>
                    <td>{{ page.views|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2">No data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-card">
        <h3>üè¢ Top ISPs</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ISP</th>
                    <th>Visitors</th>
                </tr>
            </thead>
            <tbody>
                {% for isp in top_isps %}
                <tr>
                    <td>{{ isp.isp }}</td>
                    <td>{{ isp.visitors|intcomma }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2">No data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-card">
        <h3>üõçÔ∏è Popular Products</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Views</th>
                    <th>Unique</th>
                    <th>Conv. Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for pop_product in popular_products %}
                <tr>
                    <td>{{ pop_product.product.name|truncatechars:40 }}</td>
                    <td>{{ pop_product.total_views|intcomma }}</td>
                    <td>{{ pop_product.unique_views|intcomma }}</td>
                    <td>{{ pop_product.conversion_rate|floatformat:1 }}%</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">No data available</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-card">
        <h3>üïê Recent Activity</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Visitor</th>
                    <th>Page</th>
                </tr>
            </thead>
            <tbody>
                {% for pv in recent_page_views|slice:":10" %}
                <tr>
                    <td>{{ pv.timestamp|timesince }} ago</td>
                    <td>{{ pv.visitor.ip_address }} ({{ pv.visitor.country }})</td>
                    <td>{{ pv.path|truncatechars:50 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3">No recent activity</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Traffic trend chart
const dailyStats = {{ daily_stats|safe }};
const trafficCtx = document.getElementById('trafficChart').getContext('2d');
new Chart(trafficCtx, {
    type: 'line',
    data: {
        labels: dailyStats.map(d => d.date),
        datasets: [{
            label: 'Visitors',
            data: dailyStats.map(d => d.visitors),
            borderColor: '#417690',
            backgroundColor: '#417690',
            fill: false,
            tension: 0.1
        }, {
            label: 'Page Views',
            data: dailyStats.map(d => d.page_views),
            borderColor: '#5b9bd5',
            backgroundColor: '#5b9bd5',
            fill: false,
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Countries chart
const countriesCtx = document.getElementById('countriesChart').getContext('2d');
const topCountries = {{ top_countries|safe }};
new Chart(countriesCtx, {
    type: 'doughnut',
    data: {
        labels: topCountries.slice(0, 8).map(c => c.country),
        datasets: [{
            data: topCountries.slice(0, 8).map(c => c.visitors),
            backgroundColor: [
                '#417690', '#5b9bd5', '#70ad47', '#ffc000', 
                '#c55a11', '#a64d79', '#264478', '#636363'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function changeTimeframe(timeframe) {
    window.location.href = '?timeframe=' + timeframe;
}
</script>

{% endblock %}